<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TEFA TKJ Voucher UMKM ‚Äî QRIS & WhatsApp Automation</title>
  <link rel="icon" type="image/png" sizes="32x32" href="images/LogoTKJ.png">
  <meta name="description" content="Website penjualan voucher UMKM dengan pembayaran QRIS realtime, transfer manual, pengiriman voucher WA, dan dashboard admin.">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    :root{
      --primary:#0b5ed7;
      --primary-soft:#dbeafe;
      --accent:#f59e0b;
      --muted:#6b7280;
      --bg:#f8fafc;
      --card:#ffffff;
      --card-soft:#eef2ff;
      --border:#e2e8f0;
      --radius:14px;
      --danger:#dc2626;
      --success:#059669;
      --shadow:0 15px 45px rgba(15,23,42,0.08);
    }
    [data-theme="dark"]{
      --primary:#60a5fa;
      --primary-soft:#1d4ed8;
      --accent:#f59e0b;
      --muted:#cbd5f5;
      --bg:#020617;
      --card:#0f172a;
      --card-soft:#1e293b;
      --border:#1e293b;
      --shadow:0 18px 50px rgba(2,6,23,0.8);
    }
    *{box-sizing:border-box;font-family:"Inter",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}
    body{margin:0;background:var(--bg);color:#020617;transition:background .3s,color .3s}
    body[data-theme="dark"]{color:#f8fafc}
    a{text-decoration:none;color:inherit}
    header{position:sticky;top:0;z-index:50;background:var(--card);border-bottom:1px solid var(--border);box-shadow:0 5px 20px rgba(15,23,42,0.08)}
    .nav{max-width:1200px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;gap:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{width:44px;height:44px;border-radius:12px}
    .brand-text{line-height:1.2}
    .nav-links{display:flex;gap:10px;flex-wrap:wrap}
    .nav-links a{padding:8px 14px;border-radius:999px;font-size:14px;color:var(--muted);transition:all .2s;border:1px solid transparent}
    .nav-links a:hover{color:var(--primary);border-color:var(--primary-soft);background:var(--primary-soft)}
    .cta-small{background:var(--primary);color:#fff;padding:10px 16px;border-radius:999px;border:none;font-weight:600;cursor:pointer;box-shadow:var(--shadow)}
    .toggle-theme{background:transparent;border:1px solid var(--border);border-radius:999px;padding:8px 14px;font-size:13px;cursor:pointer;color:var(--muted)}
    main{max-width:1200px;margin:0 auto;padding:24px 18px 80px}
    section{margin-top:48px}
    .hero{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:30px;align-items:center;padding:30px;border-radius:var(--radius);background:linear-gradient(135deg,#dbeafe,#fef3c7)}
    body[data-theme="dark"] .hero{background:linear-gradient(135deg,#0f172a,#1d4ed8)}
    .hero h1{font-size:36px;margin:0 0 16px;font-weight:800}
    .hero p{color:#1f2937;margin:0 0 24px;font-size:16px;line-height:1.6}
    body[data-theme="dark"] .hero p{color:#e2e8f0}
    .hero-highlight{display:flex;gap:12px;flex-wrap:wrap}
    .hero-highlight span{background:rgba(255,255,255,0.85);padding:8px 12px;border-radius:999px;font-size:13px;font-weight:600;color:#0f172a}
    body[data-theme="dark"] .hero-highlight span{background:rgba(15,23,42,0.5);color:#f8fafc}
    .btn-primary{background:var(--primary);color:#fff;border:none;padding:14px 26px;font-weight:600;border-radius:999px;cursor:pointer;box-shadow:var(--shadow);font-size:16px}
    .btn-ghost{border:1px solid var(--border);background:transparent;color:var(--primary);padding:12px 22px;border-radius:999px;font-weight:600;cursor:pointer}
    .btn-secondary{background:var(--card-soft);color:#0f172a;border:none;padding:10px 16px;border-radius:12px;font-weight:600}
    body[data-theme="dark"] .btn-secondary{color:#e2e8f0}
    .section-head{display:flex;justify-content:space-between;gap:12px;align-items:flex-end}
    .section-head h2{margin:0;font-size:28px}
    .section-head p{margin:0;color:var(--muted);font-size:14px}
    .feature-grid,.products,.flow-grid,.admin-grid,.payment-grid,.faq-grid{display:grid;gap:18px}
    .feature-grid{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
    .feature-card h3{margin:12px 0 6px;font-size:18px}
    .feature-card p{margin:0;color:var(--muted);font-size:14px;line-height:1.5}
    .products{grid-template-columns:repeat(auto-fit,minmax(250px,1fr))}
    .product{display:flex;flex-direction:column;justify-content:space-between;gap:12px}
    .product .price{font-size:28px;font-weight:800;color:var(--primary)}
    .badge{display:inline-block;padding:6px 12px;border-radius:999px;font-size:12px;background:var(--primary-soft);color:var(--primary);font-weight:600}
    .flow-grid{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    .flow-card{position:relative;padding-left:28px}
    .flow-card::before{content:"";position:absolute;left:8px;top:12px;bottom:12px;width:2px;background:var(--border)}
    .flow-card span{display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:var(--primary-soft);color:var(--primary);font-weight:700;position:absolute;left:0;top:12px}
    .payment-grid{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:12px;border-bottom:1px solid var(--border);text-align:left}
    th{background:var(--card-soft);color:#0f172a}
    body[data-theme="dark"] th{color:#e2e8f0}
    .status{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600}
    .status-paid{background:#dcfce7;color:#166534}
    .status-pending{background:#fef3c7;color:#92400e}
    .status-failed{background:#fee2e2;color:#b91c1c}
    .admin-grid{grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .stat-value{font-size:32px;font-weight:800;margin:4px 0}
    .chart{display:flex;gap:12px;align-items:flex-end;height:180px;padding:16px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .chart-bar{flex:1;display:flex;flex-direction:column;align-items:center;gap:10px}
    .bar{width:100%;background:var(--primary-soft);border-radius:12px 12px 0 0;display:flex;align-items:flex-end;justify-content:center}
    .bar-fill{width:100%;background:var(--primary);border-radius:12px 12px 0 0}
    .chart-label{font-size:12px;color:var(--muted);text-align:center}
    .faq-grid{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    .faq-card h4{margin:0 0 8px}
    .tag-list{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tag{padding:6px 10px;border-radius:999px;background:var(--card-soft);font-size:12px;color:#0f172a}
    body[data-theme="dark"] .tag{color:#e2e8f0}
    .timeline{display:flex;gap:14px;flex-wrap:wrap}
    .timeline span{background:var(--card);border:1px dashed var(--border);padding:10px 14px;border-radius:var(--radius);font-size:13px}
    .input-border{border:1px solid var(--border);border-radius:10px;padding:12px;font-size:14px;width:100%}
    .history-wrap{margin-top:18px}
    .empty{text-align:center;color:var(--muted);padding:20px}
    footer{margin-top:80px;text-align:center;color:var(--muted);font-size:14px;padding:24px 0;border-top:1px solid var(--border)}
    .floating-cart{position:fixed;right:20px;bottom:20px;z-index:60}
    .floating-cart button{background:var(--accent);color:#fff;border:none;padding:14px 22px;border-radius:999px;font-weight:700;box-shadow:0 15px 30px rgba(245,158,11,0.4);cursor:pointer}
    @media(max-width:720px){
      .nav{flex-direction:column;align-items:flex-start}
      .nav-links{width:100%;overflow:auto}
      .hero{padding:24px}
      .section-head{flex-direction:column;align-items:flex-start}
    }
    .modal{position:fixed;inset:0;background:rgba(15,23,42,0.65);display:none;align-items:center;justify-content:center;padding:18px;z-index:100}
    .modal.open{display:flex}
    .panel{background:var(--card);color:inherit;border-radius:var(--radius);padding:24px;width:100%;max-width:620px;box-shadow:var(--shadow);max-height:90vh;overflow:auto}
    .bank-info{background:var(--card-soft);padding:14px;border-radius:var(--radius);border:1px dashed var(--primary);font-family:monospace;font-size:14px}
    .alert{padding:14px;border-radius:var(--radius);font-size:14px;margin-bottom:12px}
    .alert-info{background:var(--primary-soft);color:#0f172a}
    .alert-warning{background:#fef3c7;color:#92400e}
    .alert-success{background:#dcfce7;color:#166534}
    .success-voucher{background:#020617;color:#fff;padding:14px;border-radius:var(--radius);font-family:monospace;font-size:13px;margin-top:12px}
  </style>
</head>
<body data-theme="light">
  <header>
    <div class="nav">
      <div class="brand">
        <img src="images/LogoTKJ.png" alt="TEFA TKJ">
        <img src="images/jb.png" alt="SMK JB" style="width:40px;height:40px;border-radius:10px">
        <div class="brand-text">
          <strong>TEFA TKJ ‚Äî SMK Jaya Buana</strong>
          <div style="font-size:13px;color:var(--muted)">Voucher Internet</div>
        </div>
      </div>
      <div class="controls">
        <button class="toggle-theme" id="themeToggle">üåô Mode Gelap</button>
        <a class="cta-small" href="admin.html" target="_blank">üîê Login Admin</a>
      </div>
    </div>
  </header>

  <main>
    <section id="paket">
      <div class="section-head">
        <div>
          <h2>Daftar Paket Voucher</h2>
          <p>Paket fleksibel mulai 1 jam hingga langganan bulanan.</p>
        </div>
        <button class="btn-secondary" onclick="openCart()">Lihat Keranjang</button>
      </div>
      <div class="products" id="productList">
        <div class="card">Memuat paket...</div>
      </div>
    </section>

    <section id="beli">
      <div style="margin-top:22px;display:flex;gap:12px;flex-wrap:wrap">
        <button class="btn-primary" onclick="scrollToSection('paket')">Tambah ke Keranjang</button>
        <button class="btn-secondary" onclick="openCart()">Checkout Sekarang</button>
      </div>
    </section>

    <section id="riwayat">
      <div class="section-head">
        <div>
          <h2>Riwayat Pembelian</h2>
          <p>Cek voucher kapan saja menggunakan nomor WhatsApp.</p>
        </div>
      </div>
      <form id="historyForm" class="card">
        <label for="historyInput">Nomor WhatsApp</label>
        <input class="input-border" id="historyInput" type="tel" placeholder="08xx..." pattern="08[0-9]{8,}" required>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
          <button class="btn-primary" type="submit">üîé Lihat Riwayat</button>
          <button class="btn-secondary" type="button" onclick="resetHistory()">Reset</button>
        </div>
      </form>
      <div class="card history-wrap" id="historyResult">
        <div class="empty">Masukkan nomor WhatsApp untuk menampilkan riwayat transaksi Anda.</div>
      </div>
    </section>
  </main>

  <div class="floating-cart">
    <button onclick="openCart()">üõí Keranjang <span id="cartCount">(0)</span></button>
  </div>

  <footer>
    ¬© <span id="year"></span> TEFA TKJ SMK Jaya Buana
  </footer>

  <!-- Modals & Checkout -->
  <div id="cartModal" class="modal" onclick="if(event.target===this)closeModal('cartModal')">
    <div class="panel">
      <h3>üõí Keranjang Belanja</h3>
      <div id="cartItems"></div>
      <div style="display:flex;gap:12px;margin-top:18px;flex-wrap:wrap">
        <button class="btn-secondary" onclick="closeModal('cartModal')">Tutup</button>
        <button class="btn-primary" onclick="goToCheckout()">Lanjut Checkout</button>
      </div>
    </div>
  </div>

  <div id="checkoutModal" class="modal" onclick="if(event.target===this)closeModal('checkoutModal')">
    <div class="panel">
      <h3>üí≥ Data Pembeli</h3>
      <form onsubmit="event.preventDefault(); goToPaymentMethod();">
        <label>Nama Lengkap (opsional)
          <input class="input-border" id="buyerName" type="text" placeholder="Nama Anda">
        </label>
        <label>Nomor WhatsApp (wajib)
          <input class="input-border" id="buyerPhone" type="tel" placeholder="08xx..." required pattern="08[0-9]{8,}">
        </label>
        <div class="card" style="margin:16px 0;background:var(--card-soft)">
          <div>Total Item: <strong id="totalQty">0</strong></div>
          <div>Total Harga: <strong id="checkoutSummary">Rp 0</strong></div>
        </div>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <button type="button" class="btn-primary" onclick="goToQRIS()">Bayar QRIS</button>
          <button type="button" class="btn-secondary" onclick="goToTransfer()">Transfer Manual</button>
        </div>
        <button type="button" class="btn-secondary" style="margin-top:12px" onclick="closeModal('checkoutModal')">Batal</button>
      </form>
    </div>
  </div>

  <div id="qrisModal" class="modal" onclick="if(event.target===this)closeModal('qrisModal')">
    <div class="panel" style="text-align:center">
      <h3>üí∞ Bayar dengan QRIS</h3>
      <p>Scan QR berikut dari aplikasi bank/e-wallet Anda.</p>
      <div id="qrcode" style="margin:0 auto;width:220px;height:220px"></div>
      <div class="timer" id="qrisTimer">‚è∞ 15:00</div>
      <div class="card" style="background:var(--card-soft)">
        Total Pembayaran: <strong id="qrisAmount">Rp 0</strong>
        <div style="font-size:13px;color:var(--muted)">Kadaluarsa dalam 15 menit.</div>
      </div>
      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:18px">
        <button class="btn-primary" onclick="confirmQRISPayment()">‚úÖ Saya Sudah Bayar</button>
        <button class="btn-secondary" onclick="cancelQRIS()">‚ùå Batal</button>
      </div>
    </div>
  </div>

  <div id="transferModal" class="modal" onclick="if(event.target===this)closeModal('transferModal')">
    <div class="panel">
      <h3>üè¶ Transfer Bank Manual</h3>
      <div class="alert alert-info">Silakan transfer sesuai nominal berikut.</div>
      <div class="bank-info">
        <div>Bank: BCA</div>
        <div>No Rek: 123 456 789</div>
        <div>Atas Nama: Rohmad Kuswindarto</div>
        <div style="margin-top:12px">Total: <strong id="transferAmount">Rp 0</strong></div>
      </div>
      <div class="alert alert-warning" style="margin-top:12px">
        Transfer sesuai nominal, simpan bukti, lalu klik ‚ÄúKonfirmasi Sudah Transfer‚Äù.
      </div>
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <button class="btn-secondary" onclick="cancelTransfer()">Batal</button>
        <button class="btn-primary" onclick="confirmTransferPayment()">Konfirmasi Sudah Transfer</button>
      </div>
    </div>
  </div>

  <div id="successModal" class="modal" onclick="if(event.target===this)closeModal('successModal')">
    <div class="panel" style="text-align:center">
      <h2>‚úÖ Pembayaran Berhasil</h2>
      <p>Voucher telah dikirim ke WhatsApp Anda.</p>
      <div class="alert alert-success" id="successSummary"></div>
      <div class="success-voucher" id="successVouchers">-</div>
      <button class="btn-primary" style="margin-top:16px" onclick="closeSuccess()">Tutup</button>
    </div>
  </div>

  <script>
    const CART_KEY = 'tkj_cart';
    const ORDERS_KEY = 'tkj_orders';
    const VOUCHERS_KEY = 'tkj_vouchers';
    const LAST_PHONE_KEY = 'tkj_last_phone';
    const THEME_KEY = 'tkj_theme';

    let cart = [];
    let allOrders = [];
    let allVouchers = [];
    let products = [];
    let currentOrder = null;
    let qrisTimer = null;

    const currency = n => 'Rp ' + Number(n || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    const scrollToSection = id => document.getElementById(id)?.scrollIntoView({ behavior:'smooth' });
    const openModal = id => document.getElementById(id).classList.add('open');
    const closeModal = id => document.getElementById(id).classList.remove('open');

    function saveState(){
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
      localStorage.setItem(ORDERS_KEY, JSON.stringify(allOrders));
      localStorage.setItem(VOUCHERS_KEY, JSON.stringify(allVouchers));
    }
    function loadState(){
      cart = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
      allOrders = JSON.parse(localStorage.getItem(ORDERS_KEY) || '[]');
      allVouchers = JSON.parse(localStorage.getItem(VOUCHERS_KEY) || '[]');
    }

    function initProducts(){
      products = [
        {_id:'1',name:'jaya buana',duration:'Aktif 12 jam',price:2000,description:'Paket hemat akses 12 jam.'},
        {_id:'2',name:'wifi jaya buana',duration:'Aktif 12 jam',price:2000,description:'Akses 12 jam untuk kebutuhan cepat.'},
        {_id:'3',name:'jaya buana',duration:'Aktif 4 hari',price:2000,description:'Paket ekonomis untuk penggunaan harian.'},
        {_id:'4',name:'wifi jaya buana',duration:'Aktif 4 hari',price:5000,description:'Paket 4 hari dengan koneksi stabil.'},
        {_id:'5',name:'jaya buana',duration:'Aktif 7 hari',price:8000,description:'Ideal untuk penggunaan mingguan.'},
        {_id:'6',name:'wifi jaya buana',duration:'Aktif 7 hari',price:8000,description:'Akses 7 hari untuk aktivitas online.'}

      ];
      const list = document.getElementById('productList');
      list.innerHTML = '';
      products.forEach(item => {
        const el = document.createElement('div');
        el.className = 'product card';
        el.innerHTML = `
          <div>
            <div class="badge">${item.duration}</div>
            <h3>${item.name}</h3>
            <p style="color:var(--muted)">${item.description}</p>
          </div>
          <div>
            <div class="price">${currency(item.price)}</div>
            <button class="btn-primary" style="width:100%" onclick="addToCart('${item._id}')">‚ûï Tambah</button>
          </div>
        `;
        list.appendChild(el);
      });
    }

    function addToCart(id){
      const product = products.find(p => p._id === id);
      if(!product) return;
      const existing = cart.find(item => item._id === id);
      existing ? existing.qty++ : cart.push({...product, qty:1});
      saveState();
      updateCartCount();
      openCart();
    }
    function updateCartCount(){
      const total = cart.reduce((sum,item)=>sum+item.qty,0);
      document.getElementById('cartCount').textContent = `(${total})`;
    }
    function renderCart(){
      const wrap = document.getElementById('cartItems');
      if(!wrap) return;
      if(!cart.length){wrap.innerHTML = '<div class="empty">Keranjang kosong.</div>';return;}
      let total = 0;
      let html = '<table><thead><tr><th>Paket</th><th>Qty</th><th>Subtotal</th><th></th></tr></thead><tbody>';
      cart.forEach(item=>{
        total += item.price * item.qty;
        html += `<tr>
          <td><strong>${item.name}</strong><div style="color:var(--muted);font-size:12px">${item.duration}</div></td>
          <td style="display:flex;align-items:center;gap:6px">
            <button class="btn-secondary" style="padding:4px 10px" onclick="changeQty('${item._id}',-1)">-</button>
            ${item.qty}
            <button class="btn-secondary" style="padding:4px 10px" onclick="changeQty('${item._id}',1)">+</button>
          </td>
          <td>${currency(item.price*item.qty)}</td>
          <td><button class="btn-danger" style="padding:4px 10px" onclick="removeItem('${item._id}')">Hapus</button></td>
        </tr>`;
      });
      html += '</tbody></table>';
      html += `<div style="text-align:right;margin-top:12px;font-weight:700">Total: ${currency(total)}</div>`;
      wrap.innerHTML = html;
    }
    function changeQty(id, delta){
      const item = cart.find(i=>i._id===id);
      if(!item) return;
      item.qty += delta;
      if(item.qty<=0) cart = cart.filter(i=>i._id!==id);
      saveState();
      renderCart();
      updateCartCount();
    }
    function removeItem(id){
      cart = cart.filter(i=>i._id!==id);
      saveState();
      renderCart();
      updateCartCount();
    }
    const openCart = () => { renderCart(); openModal('cartModal'); };

    function goToCheckout(){
      if(!cart.length){alert('Keranjang kosong');return;}
      const totalQty = cart.reduce((s,i)=>s+i.qty,0);
      const totalPrice = cart.reduce((s,i)=>s+i.qty*i.price,0);
      document.getElementById('totalQty').textContent = totalQty;
      document.getElementById('checkoutSummary').textContent = currency(totalPrice);
      closeModal('cartModal');
      openModal('checkoutModal');
    }

    const createOrder = base => {
      const totalQty = cart.reduce((s,i)=>s+i.qty,0);
      const totalPrice = cart.reduce((s,i)=>s+i.qty*i.price,0);
      return {
        _id:'order_'+Date.now(),
        buyerName:base.name || 'Pembeli',
        buyerPhone:base.phone,
        items:cart.map(c=>({packageId:c._id,name:c.name,price:c.price,qty:c.qty})),
        totalPrice,
        totalQty,
        status:'pending',
        voucherIssued:[],
        createdAt:new Date().toISOString(),
        paymentMethod:'pending'
      };
    };

    function validateBuyer(){
      const phone = document.getElementById('buyerPhone').value.trim();
      if(!/^08[0-9]{8,}$/.test(phone)){alert('Nomor WhatsApp tidak valid.');return null;}
      const name = document.getElementById('buyerName').value.trim();
      return {phone,name};
    }

    function goToPaymentMethod(){
      const buyer = validateBuyer();
      if(!buyer) return;
      currentOrder = createOrder(buyer);
    }

    function goToQRIS(){
      const buyer = validateBuyer();
      if(!buyer) return;
      currentOrder = createOrder(buyer);
      document.getElementById('qrcode').innerHTML = '';
      new QRCode(document.getElementById('qrcode'),{
        text:`QRIS-${currentOrder._id}-${currentOrder.totalPrice}`,
        width:220,height:220,colorDark:'#0b5ed7',colorLight:'#fff'
      });
      document.getElementById('qrisAmount').textContent = currency(currentOrder.totalPrice);
      startQRISTimer();
      closeModal('checkoutModal');
      openModal('qrisModal');
    }

    function startQRISTimer(){
      if(qrisTimer) clearInterval(qrisTimer);
      let remaining = 15*60;
      const timerEl = document.getElementById('qrisTimer');
      qrisTimer = setInterval(()=>{
        const m=String(Math.floor(remaining/60)).padStart(2,'0');
        const s=String(remaining%60).padStart(2,'0');
        timerEl.textContent = `‚è∞ ${m}:${s}`;
        if(remaining<=0){
          clearInterval(qrisTimer);
          cancelQRIS();
          alert('QRIS kadaluarsa. Silakan buat order baru.');
        }
        remaining--;
      },1000);
    }
    function confirmQRISPayment(){
      if(!currentOrder) return;
      if(qrisTimer) clearInterval(qrisTimer);
      processPayment('qris','paid');
    }
    function cancelQRIS(){
      if(qrisTimer) clearInterval(qrisTimer);
      closeModal('qrisModal');
      currentOrder = null;
    }

    function goToTransfer(){
      const buyer = validateBuyer();
      if(!buyer) return;
      currentOrder = createOrder(buyer);
      document.getElementById('transferAmount').textContent = currency(currentOrder.totalPrice);
      closeModal('checkoutModal');
      openModal('transferModal');
    }
    function confirmTransferPayment(){
      if(!currentOrder) return;
      processPayment('transfer','pending_confirmation');
    }
    function cancelTransfer(){
      closeModal('transferModal');
      currentOrder = null;
    }

    function generateVoucherCode(){
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let code = 'TKJ-';
      for(let i=0;i<8;i++) code += chars[Math.floor(Math.random()*chars.length)];
      return code.match(/.{1,4}/g).join('-');
    }

    function processPayment(method,status){
      currentOrder.paymentMethod = method;
      currentOrder.status = status==='pending_confirmation' ? 'pending_confirmation' : 'paid';
      const issued = [];
      for(let i=0;i<currentOrder.totalQty;i++){
        const voucher = {
          _id:'voucher_'+Date.now()+'_'+i,
          code:generateVoucherCode(),
          package:currentOrder.items[0]?.name || 'Paket Umum',
          status:'used',
          owner:currentOrder.buyerPhone,
          issuedAt:new Date().toISOString()
        };
        allVouchers.push(voucher);
        issued.push(voucher.code);
      }
      currentOrder.voucherIssued = issued;
      allOrders.push(currentOrder);
      saveState();
      cart = [];
      updateCartCount();
      renderCart();
      renderHistorySection(localStorage.getItem(LAST_PHONE_KEY)||'');
      if(method==='transfer' && status==='pending_confirmation'){
        alert('Terima kasih! Admin akan memverifikasi transfer Anda.');
        closeModal('transferModal');
      } else {
        closeModal('qrisModal');
        showSuccess(currentOrder);
      }
      currentOrder = null;
    }

    function showSuccess(order){
      document.getElementById('successSummary').innerHTML =
        `Nama: <strong>${order.buyerName}</strong><br>No WA: <strong>${order.buyerPhone}</strong><br>Total: <strong>${currency(order.totalPrice)}</strong>`;
      document.getElementById('successVouchers').textContent = order.voucherIssued.join('\n');
      openModal('successModal');
    }
    const closeSuccess = () => closeModal('successModal');

    function renderHistorySection(phone){
      const container = document.getElementById('historyResult');
      if(!phone){
        container.innerHTML = '<div class="empty">Masukkan nomor WhatsApp untuk menampilkan riwayat.</div>';
        return;
      }
      const orders = allOrders.filter(o=>o.buyerPhone===phone);
      if(!orders.length){
        container.innerHTML = '<div class="empty">Belum ada transaksi dengan nomor tersebut.</div>';
        return;
      }
      let html = '<table><thead><tr><th>Tanggal</th><th>Total</th><th>Status</th><th>Voucher</th></tr></thead><tbody>';
      orders.forEach(order=>{
        const statusClass = order.status==='paid' ? 'status status-paid'
          : order.status==='pending_confirmation' ? 'status status-pending'
          : 'status status-failed';
        html += `<tr>
          <td>${new Date(order.createdAt).toLocaleString('id-ID')}</td>
          <td>${currency(order.totalPrice)}</td>
          <td><span class="${statusClass}">${order.status}</span></td>
          <td>${order.voucherIssued.join('<br>')}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }
    function resetHistory(){
      document.getElementById('historyInput').value = '';
      localStorage.removeItem(LAST_PHONE_KEY);
      renderHistorySection('');
    }


    document.getElementById('historyForm').addEventListener('submit',e=>{
      e.preventDefault();
      const phone = document.getElementById('historyInput').value.trim();
      if(!/^08[0-9]{8,}$/.test(phone)){alert('Nomor WA tidak valid.');return;}
      localStorage.setItem(LAST_PHONE_KEY,phone);
      renderHistorySection(phone);
    });

    function initTheme(){
      const saved = localStorage.getItem(THEME_KEY) || 'light';
      document.body.setAttribute('data-theme',saved);
      document.getElementById('themeToggle').textContent = saved==='light' ? 'üåô Mode Gelap' : '‚òÄÔ∏è Mode Terang';
    }
    document.getElementById('themeToggle').addEventListener('click',()=>{
      const current = document.body.getAttribute('data-theme');
      const next = current==='light' ? 'dark' : 'light';
      document.body.setAttribute('data-theme',next);
      localStorage.setItem(THEME_KEY,next);
      document.getElementById('themeToggle').textContent = next==='light' ? 'üåô Mode Gelap' : '‚òÄÔ∏è Mode Terang';
    });

    function init(){
      loadState();
      initProducts();
      updateCartCount();
      renderCart();
      const lastPhone = localStorage.getItem(LAST_PHONE_KEY);
      if(lastPhone){
        document.getElementById('historyInput').value = lastPhone;
        renderHistorySection(lastPhone);
      }
      initTheme();
      document.getElementById('year').textContent = new Date().getFullYear();
    }

    window.addEventListener('load',init);
  </script>
</body>
</html>

